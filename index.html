<!--B"H-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kabbalistic ES6 AST Parser</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital@1&family=Roboto+Mono&display=swap');
        body { background-color: #1a1a1d; color: #c5c6c7; font-family: 'Roboto Mono', monospace; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        h1, h3 { font-family: 'Crimson Text', serif; color: #66fcf1; text-shadow: 0 0 5px #45a29e; text-align: center; }
        .container { display: flex; flex-direction: column; width: 90%; max-width: 1200px; gap: 20px; }
        .io-box { display: flex; flex-direction: column; width: 100%; }
        textarea, pre { background-color: #0b0c10; border: 1px solid #45a29e; color: #c5c6c7; padding: 15px; font-family: 'Roboto Mono', monospace; font-size: 14px; border-radius: 5px; height: 300px; resize: vertical; }
        pre { white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; }
        .error { color: #ff6b6b !important; font-weight: bold; border-color: #ff6b6b !important; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        button { background-color: #66fcf1; color: #0b0c10; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; font-weight: bold; border-radius: 5px; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        button:hover { background-color: #45a29e; box-shadow: 0 0 10px #66fcf1; }
        label { margin-bottom: 5px; font-size: 18px; color: #66fcf1; }
    </style>
</head>
<body>

    <h1>B"H Kabbalistic AST Parser</h1>
    <h3>Unveiling the hidden soul of ES6 JavaScript.</h3>

    <div class="container">
        <div class="io-box">
            <label for="js-input">Paste JavaScript Emanation Here:</label>
            <textarea id="js-input" spellcheck="false"></textarea>
        </div>
        
        <div class="controls">
            <button id="parse-btn">Parse the Emanation</button>
            <button id="copy-btn">Copy the Tree</button>
        </div>

        <div class="io-box">
             <label for="ast-output">Abstract Syntax Tree (The Unveiling):</label>
            <pre id="ast-output"></pre>
        </div>
    </div>
    
    <!-- Load scripts in the correct, required order -->
    <script src="constants.js"></script>
    <script src="Lexer.js"></script>

    <!-- The core parser MUST be loaded first -->
    <script src="parser-core.js"></script>

    <!-- Load the component files that extend the parser's prototype -->
    <script src="parser-expressions.js"></script>
    <script src="parser-statements.js"></script>
    <script src="parser-declarations.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const jsInput = document.getElementById('js-input');
        const astOutput = document.getElementById('ast-output');
        const parseButton = document.getElementById('parse-btn');
        const copyButton = document.getElementById('copy-btn');

        // --- THE UNBREAKABLE ASSEMBLY ---
        // We create the parser object ONLY ONCE, after we are 100% certain
        // all component files have been loaded and executed by the browser.
        const parser = new MerkabahParser(''); // Create a reusable parser instance

        // The registration of parsing functions also only needs to happen ONCE.
        // These methods are now guaranteed to exist on the prototype.
        parser.registerExpressionParsers();
        parser.registerStatementParsers();
        parser.registerDeclarationParsers();
        // --- END OF ASSEMBLY ---

        const runParser = () => {
            astOutput.textContent = '';
            astOutput.classList.remove('error');
            const sourceCode = jsInput.value;

            // --- USE THE FULLY-BUILT PARSER ---
            // Re-initialize the parser with the new source code. This is
            // vastly more efficient and avoids all race conditions.
            parser.reinitialize(sourceCode); // We will add this method.

            const ast = parser.parse();

            if (parser.errors.length > 0) {
                const errorMessage = "The vessels have shattered. The following transgressions were observed:\n\n" + parser.errors.join('\n');
                astOutput.textContent = errorMessage;
                astOutput.classList.add('error'); // Make errors visually distinct
            } else {
                astOutput.textContent = JSON.stringify(ast, null, 2);
            }
        };

        const copyAstToClipboard = () => {
            if (!astOutput.textContent || astOutput.classList.contains('error')) {
                alert('There is no valid AST to copy.'); return;
            }
            navigator.clipboard.writeText(astOutput.textContent)
                .then(() => alert('AST copied to clipboard!'))
                .catch(err => {
                    console.error('Failed to copy AST: ', err);
                    alert('Could not copy AST. See the console for details.');
                });
        };

        parseButton.addEventListener('click', runParser);
        copyButton.addEventListener('click', copyAstToClipboard);

        jsInput.value = `/*B"H*/\nvar f = 3;`; // Set initial text for testing
        runParser(); // Initial parse
    });
    </script>

</body>
</html>